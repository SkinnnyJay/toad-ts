# TOAD TypeScript - Development Guide

## Development Process

### Task Management Process

When handling each new task, you should:

1. Review Scratchpad content to understand the current context
   - Read `scratchpad/plan.md` for current phase and tasks
   - Read `scratchpad/journal.md` for recent decisions and context
   - Review `scratchpad/progress.md` for task status
2. Clean up old task-related content (if needed)
3. Explain the task's objectives and scope
4. Plan specific task steps
5. Use markers to track progress: [X] for completed, [ ] for todo
6. Reflect and plan at milestones
7. Update `.cursorrules` when gaining important insights

### Scratchpad Usage

- `scratchpad/plan.md` - Master implementation plan with phases and tasks
- `scratchpad/journal.md` - Daily work log and decision documentation
- `scratchpad/progress.md` - Task tracking and status
- `scratchpad/` - Experimental research code; avoid shipping changes from here

---

## Project Structure & Module Organization

### Directory Structure

- `src/utils/` - Production TypeScript utilities, grouped by domain:
  - `env/` - Environment parsing and validation
  - `logging/` - Logger setup and correlation context
  - `token-optimizer/` - Core optimizer, strategies, telemetry, and stubs
- `src/core/` - Core infrastructure (ACP, handlers, DI)
- `src/store/` - Zustand state management
- `src/ui/` - Ink/React UI components
- `src/types/` - TypeScript type definitions
- `scratchpad/` - Experimental research code; avoid shipping changes from here
- `dist/` - Build output (generated by `npm run build`)
- Root configs: `tsup.config.ts`, `vitest.config.ts`, `tsconfig.json`, `biome.json`

### File Naming Conventions

- **camelCase** for class files: `tokenOptimizer.ts` (class name is PascalCase)
- **Utility suffixes**: `*.utils.ts` for utility functions
- **Type files**: `*.types.ts` for type definitions
- **Test files**: `*.test.ts` suffix, live beside the module
  - Example: `src/utils/env/env.utils.test.ts`
  - Test files follow format: `<fileName>.<test type>.test.ts`
  - Test folders: `unit/`, `integration/`, `fixtures/`, `e2e/`
- **Path alias**: `@/` maps to `src/` (e.g., `@/utils/env`)

---

## Code Style & Naming Conventions

### TypeScript Standards

- **TypeScript strict mode** with `noUncheckedIndexedAccess` enabled
- **ESM-only** (`"type": "module"`)
- **No `any` types** - Use explicit types or `unknown` with type guards
- **No implicit `any`** - Explicit types on public APIs
- **Branded types** for IDs (SessionID, AgentID, MessageID) to prevent mixing
- **Zod schemas** for all domain types and runtime validation
- **Interfaces over abstract classes** for provider abstraction (ports/adapters pattern)

### Biome Configuration

- **2-space indent**
- **100 character line width**
- **Double quotes** for strings
- **Semicolons** required
- **Biome** for linting and formatting (not ESLint/Prettier)

### Code Quality Principles

- **Prefer deletion over addition** - Remove complexity
- **Prefer clarity over cleverness** - Readable code first
- **Prefer types over comments** - Let types document code
- **Prefer composition over flags** - Avoid boolean flags with unclear intent
- **Contract-first development** - Define Zod schemas and interfaces before logic
- **Dependency injection** - Use factory functions for DI, not container libraries
- **No AI slop** - Avoid redundant comments, over-explaining, generic helpers
- **No junior mistakes** - Proper naming, no magic numbers/strings, no long functions

### Literal Extraction Guidelines

**When to extract literals into constants:**

1. **Status strings** - Any status/enum-like strings used in switch/case or if/else chains
2. **Magic numbers** - Timeouts, limits, thresholds, retry counts (except 0, 1, -1 in obvious contexts)
3. **Repeated strings** - Any string literal that appears 2+ times across files or 3+ times in one file
4. **Control flow strings** - Strings used in switch/case, if/else chains, or state machines
5. **Domain constants** - Error codes, environment keys, file paths, encoding names, signal names
6. **UI constants** - Color names, keyboard input characters, permission patterns

**Constant module pattern:**

```typescript
// src/constants/example-status.ts
export const EXAMPLE_STATUS = {
  PENDING: "pending",
  RUNNING: "running",
  COMPLETED: "completed",
} as const;

export type ExampleStatus = typeof EXAMPLE_STATUS[keyof typeof EXAMPLE_STATUS];

// Re-export for convenience
export const { PENDING, RUNNING, COMPLETED } = EXAMPLE_STATUS;
```

**Zod schema integration:**

```typescript
import { EXAMPLE_STATUS } from "@/constants/example-status";

// Use constants in Zod enums
status: z.enum([
  EXAMPLE_STATUS.PENDING,
  EXAMPLE_STATUS.RUNNING,
  EXAMPLE_STATUS.COMPLETED,
])
```

**Never use string literals in:**
- Switch/case statements (use constants)
- If/else chains checking status/state (use constants)
- Environment variable keys (use constants from `src/constants/env-keys.ts`)
- Error code comparisons (use constants from `src/constants/error-codes.ts`)

### Naming Patterns

- **Variables/Functions**: camelCase
- **Classes**: PascalCase
- **Constants**: UPPER_SNAKE_CASE or const objects with `as const`
- **Types/Interfaces**: PascalCase
- **Files**: camelCase (matching class name if applicable)

---

## Architecture Patterns

### Design Principles

- **Interfaces-first**: Depend on abstractions (ports), not concretions (adapters)
- **Type safety is a feature**: No silent `any`, no `as` casting to hush errors
- **Performance is product**: Measure p50/p95/p99 latency, streaming UX, caching
- **Reliability by design**: Retries, circuit breakers, rate limiting, observability
- **Composable architecture**: Reusable, dependency-injected modules with clear boundaries

### Dependency Injection

- Use **factory functions** for DI, not container libraries (InversifyJS, TSyringe)
- Define `Dependencies` interfaces (e.g., `TokenOptimizerDependencies`)
- Explicit dependencies, no magic
- Easy to test (just pass mocks)

### Provider Abstraction

- Use **TypeScript interfaces** (ports) for provider abstraction
- Enables multiple inheritance (e.g., `OptimizedProvider extends Provider`)
- Easier to mock in tests
- Aligns with dependency inversion principle

### State Management

- **Zustand** for state management (not Redux or Context API)
- Minimal boilerplate, TypeScript-first with excellent inference
- Small bundle size, built-in middleware support

---

## Testing Guidelines

### Framework

- **Vitest** with globals enabled for unit and integration tests
- **Playwright** for E2E tests (when applicable)
- Test files use `.test.ts` suffix and live beside the module
- Separate configs for unit, integration, e2e, and scenarios

### Test Organization

- Test files follow format: `<fileName>.<test type>.test.ts`
- Test folders: `unit/`, `integration/`, `fixtures/`, `e2e/`
- Example: `src/utils/env/env.utils.test.ts`

### Testing Standards

- **Target >= 95% unit coverage** per class/service and meaningful integration tests
- **Behavior-first tests** - Test what, not how
- **Favor integration where valuable** - Test contracts across boundaries
- **Use AAA pattern** (Arrange, Act, Assert) or Given-When-Then consistently
- **No flaky tests** - Remove nondeterminism (timing, random data, shared state)
- **Use auto-waiting** - Never sleep-based timeouts
- **Mock sparingly** - Prefer real integrations in integration tests
- **Use fake timers** for time-based code instead of waiting

### Test Execution

- Run a single test: `npx vitest run src/utils/env/env.utils.test.ts`
- Exclude third-party/vendor/research suites from test runs via config
- Do not mask project failures

---

## Build, Test, and Development Commands

### Development

```bash
npm run dev              # Run with tsx (development mode)
npm run dev:watch        # Run with tsx in watch mode
```

### Build

```bash
npm run build            # Build with tsup (outputs to dist/)
npm run clean            # Remove dist/ and .next/
npm start                # Execute the compiled CLI from dist/
```

### Testing

```bash
npm test                 # Run all tests with vitest
npm run test:watch       # Run tests in watch mode
npm run test:unit        # Run unit tests only
npm run test:integration # Run integration tests
npm run test:e2e         # Run end-to-end tests
npm run test:scenarios   # Run E2E scenario tests
npm run test:coverage    # Run tests with coverage report
```

### Code Quality

```bash
npm run typecheck        # TypeScript type checking (tsc --noEmit)
npm run lint             # Lint with Biome
npm run lint:fix         # Lint and auto-fix
npm run format           # Format with Biome
```

---

## Execution Verification Policy (MANDATORY)

### Required Verification

**Never claim lint/typecheck/test/build/dev were run unless the exact commands completed successfully in this workspace.**

For every change cycle, run and report actual command output for:
1. `npm run lint`
2. `npm run typecheck`
3. `npm run test` (project suites only)
4. `npm run build`

### Reporting Requirements

- If any command is skipped, explicitly state it was not run and why
- Exclude third-party/vendor/research suites from test runs via config
- Do not mask project failures
- If any command fails, surface the error, do not downgrade severity, do not proceed as "green"
- Final responses must list the commands actually executed and their status (pass/fail), or explicitly state if a command was not executed

---

## Definition of Done

A task is only complete when **all** of the following are true:

- [ ] Build succeeds with no warnings blocking quality
- [ ] Type checks cleanly (`npx tsc --noEmit`)
- [ ] All tests pass; changed/added units have >= 95% coverage
- [ ] No new lint violations; formatting matches repo style
- [ ] No dead code, no unused exports, no stray TODOs
- [ ] No secrets committed; new env keys documented in `.env.sample`
- [ ] Files live in correct directories; names follow conventions
- [ ] Documentation updated if behavior/contracts changed
- [ ] `scratchpad/plan.md` updated with progress
- [ ] `scratchpad/journal.md` updated with timestamped entry (milestone + task notes, learnings)

---

## Quality Gates

Every phase must pass these gates before proceeding:

```bash
npm run format        # Code formatting
npm run lint:fix      # Linting with fixes
npm run typecheck     # Type checking
npm run test          # Test suite
npm run build         # Build verification
```

### Stop / Go Criteria

**Do not proceed ("stop") if any fail:**
- Type errors, failing tests, build errors, or lint issues
- Coverage below target without justification
- Missing updates to `plan.md` or `journal.md` when required

**Proceed ("go") only when:**
- All tests pass; build and type check are clean
- Code is clean, concise, and follows conventions
- Coverage is >= 95% for changed/added units
- `plan.md` and `journal.md` are updated; no junk files were added

---

## Error Handling

### Principles

- **Prefer early returns** - Avoid deep nesting
- **Meaningful error handling** - No empty catches
- **Use custom error classes** in `src/shared/utils/errors.ts` where appropriate
- **Provide meaningful error messages** - Help users understand what went wrong
- **Graceful degradation** - Handle failures without crashing

### Error Types

- Use appropriate error types for different failure modes
- Map external errors to domain errors at boundaries
- Log errors with context (correlation IDs, request IDs)

---

## Logging & Environment

### Logging

- Use `src/shared/utils/logger.utils.ts` (`createClassLogger`)
- Add helpful context to logs
- **Don't use `console.log`** unless it's for `__tests__`
- Use correlation context for request tracing

### Environment

- Use `src/shared/utils/env.utils.ts` (`Env`)
- **Never read `process.env` directly** (except in tests)
- Validate all external data with Zod schemas
- Document new env keys in `.env.sample`
- Use `.env.sample` to create local `.env`; never commit secrets

### Required Environment Keys

- `OPENAI_API_KEY` (required)
- `ANTHROPIC_API_KEY` (required)
- `LOG_LEVEL` (optional)
- Rate-limit caps (optional)

---

## Performance & Reliability

### Performance Targets

- **App Startup**: < 200ms p50, < 500ms p95, < 1s p99
- **Session Load**: < 100ms p50, < 300ms p95, < 500ms p99
- **Stream Chunk Render**: < 16ms p50, < 50ms p95, < 100ms p99 (60fps target)
- **Token Optimization**: < 50ms p50, < 200ms p95, < 500ms p99

### Reliability Patterns

- **Retries** with exponential backoff (max 3x)
- **Circuit breakers** for external services
- **Rate limiting** per provider
- **Dead-letter queues** for failed requests
- **Idempotency** for critical operations
- **Backpressure** - Pause streaming if render queue > 10 chunks
- **Observability** - Traces, metrics, logs

### Caching Strategy

- Session cache (in-memory Map)
- Config cache (file watcher)
- Provider validation cache (TTL: 5min)
- Token optimization cache (LRU, max 100 entries)

---

## Documentation Standards

### Code Documentation

- **JSDoc** where it matters (public APIs, complex logic)
- **Explain why, not what** - Comments should add context, not restate code
- **No redundant comments** - Let code and types be self-documenting
- **Update stale comments** - Keep documentation in sync with code

### Project Documentation

- **README.md** - Setup, usage, examples
- **API documentation** - Public interfaces and contracts
- **Architecture guide** - System design and decisions
- **Troubleshooting guide** - Common issues and solutions
- **ADR (Architecture Decision Records)** - Document major decisions with rationale

### Documentation Updates

- Update README or inline docs if behavior/contracts changed
- Update `scratchpad/plan.md` with progress and next steps
- Add timestamped entry to `scratchpad/journal.md` (milestone + task notes, learnings)
- Update `.cursorrules` when gaining important insights

---

## Security Best Practices

### Secrets Management

- **Never commit secrets** - Use `.env` file (gitignored)
- **Document env keys** in `.env.sample`
- **Use credential store** - Keychain default, encrypted disk fallback
- **Validate secrets** at startup - Fail fast if missing required keys

### Data Handling

- **Validate all external data** with Zod schemas
- **Sanitize user input** before processing
- **Handle sensitive data appropriately** - Don't log secrets
- **Implement proper authentication/authorization** when needed

---

## Commit & Pull Request Guidelines

### Commit Messages

- Use **Conventional Commits** format: `feat:`, `fix:`, `chore:`, etc.
- Keep messages **under 72 characters** for subject line
- Use **imperative mood** (e.g., `Add token telemetry storage`)
- Be concise and descriptive

### Pull Requests

- Include short summary
- Note tests run and results
- Document any config or env changes
- Link related issues
- Include screenshots only if UI output changes

---

## Guardrails

### Code Quality

- **No hallucinated APIs** - Open code or cite docs before using an API
- **Keep diffs cohesive and minimal** - Avoid unrelated changes
- **Avoid premature optimization** - Keep it simple and testable
- **Cross-platform in mind** - macOS/Linux/Windows compatibility

### Process

- **Never start servers automatically** - Provide commands for the user to run
- **Keep diffs small** - Remove obsolete files/configs
- **Follow specifications exactly** - Don't deviate without discussion
- **Document decisions** in `journal.md`

---

## Target Platform

- **Node.js 20+** per `package.json` engines
- **ESM-only** module system
- **Cross-platform** - macOS/Linux/Windows support

---

## Lessons Learned

### User-Specified Experience

[To be populated as insights are gained]

### Cursor AI Accumulated Experience

[To be populated as insights are gained]

---

## References

### Essential Documentation

- `scratchpad/plan.md` - Master implementation plan
- `scratchpad/journal.md` - Work log and decisions
- `scratchpad/progress.md` - Task tracking
- `AGENTS.md` - Repository guidelines
- `CLAUDE.md` - Claude Code guidance
- `README.md` - Project overview

### External Resources

- [ACP Protocol Spec](https://agentclientprotocol.com)
- [Ink Documentation](https://github.com/vadimdemedes/ink)
- [Zod Documentation](https://zod.dev)
- [Vitest Documentation](https://vitest.dev)
- [Biome Documentation](https://biomejs.dev)

---

**Last Updated**: 2026-01-14
**Version**: 2.0.0
